<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Berry Physics Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        /* Панель управления по центру снизу */
        #ui { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: flex; gap: 15px; align-items: center;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px);
            padding: 12px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
        }

        .btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: transparent; transition: 0.3s; color: white;
        }

        .btn svg { width: 24px; height: 24px; fill: currentColor; }
        .btn:active { transform: scale(0.8); color: #4ecca3; }
        .active-mode { color: #4ecca3 !important; background: rgba(78, 204, 163, 0.2); }
        
        #countInput {
            width: 35px; background: none; border: none; color: white;
            text-align: center; font-size: 18px; font-weight: bold; outline: none;
        }

        canvas { display: block; }
    </style>
</head>
<body>

<div id="ui">
    <input type="number" id="countInput" value="5">
    
    <button class="btn" onclick="spawnMultiple()">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>

    <button class="btn" onclick="clearAll()">
        <svg viewBox="0 0 24 24"><path d="M15,16L11,20L7.5,16.5L9,15L10,16V12H12V16L13,15L15,16M16,11V14.5L14,12.5V11H16M19,15V11H21V15H19M16,5V8H14V5H16M11,5V8H9V5H11M6,5V8H4V5H6M19,5V8H17V5H19Z"/></svg>
    </button>

    <button id="spaceBtn" class="btn" onclick="toggleSpace()">
        <svg viewBox="0 0 24 24"><path d="M13.13 22.19L11.5 18.36L13 16.86L16.84 18.5L13.13 22.19M1.51 21.49L2.78 22.72L10.36 15.13L9.11 13.9L1.51 21.49M18.87 6.13L17 8L16 7L17.87 5.13C18.5 4.5 18.5 3.5 17.87 2.87S16.5 2.25 15.87 2.87L14 4.74L13 3.74L14.87 1.87C16.27.47 18.5.47 19.87 1.87S21.27 5.1 19.87 6.5L18.87 6.13Z"/></svg>
    </button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Mouse, MouseConstraint, Events, Body } = Matter;

const engine = Engine.create();
const world = engine.world;
const render = Render.create({
    element: document.body,
    engine: engine,
    options: {
        width: window.innerWidth, height: window.innerHeight,
        wireframes: false, background: 'transparent'
    }
});

Render.run(render);
Runner.run(Runner.create(), engine);

let walls = [];
function createWalls() {
    if (walls.length) Composite.remove(world, walls);
    const w = window.innerWidth, h = window.innerHeight;
    const opt = { isStatic: true, friction: 0.5, render: { visible: false } };
    walls = [
        Bodies.rectangle(w/2, h+25, w, 50, opt),
        Bodies.rectangle(w/2, -25, w, 50, opt),
        Bodies.rectangle(-25, h/2, 50, h, opt),
        Bodies.rectangle(w+25, h/2, 50, h, opt)
    ];
    Composite.add(world, walls);
}
createWalls();

const TARGET_SIZE = 80;
let isSpaceMode = false;
let gyroRequested = false;

function createBerry(x, y) {
    const berryNum = Math.floor(Math.random() * 5) + 1;
    const imgPath = `berry${berryNum}.png`;
    const img = new Image();
    img.src = imgPath;
    img.onload = () => {
        const scale = TARGET_SIZE / img.width;
        const berry = Bodies.circle(x, y, TARGET_SIZE/2, {
            restitution: 0.8, friction: 0.2,
            render: { sprite: { texture: imgPath, xScale: scale, yScale: scale } }
        });
        Composite.add(world, berry);
    };
}

function spawnMultiple() {
    if(!gyroRequested) requestGyro();
    const count = parseInt(document.getElementById('countInput').value);
    for(let i=0; i<count; i++) {
        createBerry(Math.random()*(window.innerWidth-60)+30, 50);
    }
}

function clearAll() {
    if(!gyroRequested) requestGyro();
    Composite.allBodies(world).forEach(b => { if(!b.isStatic) Composite.remove(world, b); });
}

function toggleSpace() {
    if(!gyroRequested) requestGyro();
    isSpaceMode = !isSpaceMode;
    document.getElementById('spaceBtn').classList.toggle('active-mode');
    world.gravity.scale = isSpaceMode ? 0 : 0.001;
}

const mouse = Mouse.create(render.canvas);
const mouseConstraint = MouseConstraint.create(engine, {
    mouse: mouse, constraint: { stiffness: 0.1, render: { visible: false } }
});
Composite.add(world, mouseConstraint);

// Кручение и управление
Events.on(engine, 'afterUpdate', () => {
    if (mouseConstraint.draggedBody) {
        const b = mouseConstraint.draggedBody;
        Body.setAngularVelocity(b, b.angularVelocity + (Math.random()-0.5)*0.25);
    }
});

function requestGyro() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(res => {
            if (res === 'granted') window.addEventListener('deviceorientation', handleGyro);
        });
    } else {
        window.addEventListener('deviceorientation', handleGyro);
    }
    gyroRequested = true;
}

function handleGyro(e) {
    const sensitivity = 0.07;
    const fx = e.gamma * sensitivity;
    const fy = e.beta * sensitivity;
    
    if (!isSpaceMode) {
        world.gravity.x = fx;
        world.gravity.y = fy;
    } else {
        Composite.allBodies(world).forEach(b => {
            if(!b.isStatic) Body.applyForce(b, b.position, { x: fx * 0.0008, y: fy * 0.0008 });
        });
    }
}

window.addEventListener('resize', () => {
    render.canvas.width = window.innerWidth;
    render.canvas.height = window.innerHeight;
    createWalls();
});

spawnMultiple();
</script>
</body>
</html>
