<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Berry Dark Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000000; font-family: sans-serif; touch-action: none; }
        
        #ui { 
            position: fixed; top: 15px; left: 15px; z-index: 100; 
            display: flex; gap: 10px; align-items: center;
        }

        .btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; color: white;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px); transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .btn:active { transform: scale(0.9); background: #4ecca3; color: #000; }
        
        #countInput {
            width: 40px; background: transparent; border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 5px; border-radius: 5px; text-align: center; font-size: 16px;
        }

        .active-mode { background: #4ecca3 !important; color: #000 !important; }
        
        canvas { display: block; }
    </style>
</head>
<body>

<div id="ui">
    <input type="number" id="countInput" value="5">
    <button class="btn" onclick="spawnMultiple()">‚ûï</button>
    <button class="btn" onclick="clearAll()">üßπ</button>
    <button id="spaceBtn" class="btn" onclick="toggleSpace()">üöÄ</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Mouse, MouseConstraint, Events, Body } = Matter;

const engine = Engine.create();
const world = engine.world;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞
const render = Render.create({
    element: document.body,
    engine: engine,
    options: {
        width: window.innerWidth, height: window.innerHeight,
        wireframes: false, background: 'transparent'
    }
});

Render.run(render);
Runner.run(Runner.create(), engine);

let walls = [];
function createWalls() {
    if (walls.length) Composite.remove(world, walls);
    const w = window.innerWidth, h = window.innerHeight;
    const opt = { isStatic: true, friction: 0.3, render: { visible: false } };
    walls = [
        Bodies.rectangle(w/2, h+25, w, 50, opt),
        Bodies.rectangle(w/2, -25, w, 50, opt),
        Bodies.rectangle(-25, h/2, 50, h, opt),
        Bodies.rectangle(w+25, h/2, 50, h, opt)
    ];
    Composite.add(world, walls);
}
createWalls();

const TARGET_SIZE = 80;
let isSpaceMode = false;
let gyroRequested = false;

function createBerry(x, y) {
    const berryNum = Math.floor(Math.random() * 5) + 1;
    const imgPath = `berry${berryNum}.png`;
    const img = new Image();
    img.src = imgPath;
    img.onload = () => {
        const scale = TARGET_SIZE / img.width;
        const berry = Bodies.circle(x, y, TARGET_SIZE/2, {
            restitution: 0.7, friction: 0.2,
            render: { sprite: { texture: imgPath, xScale: scale, yScale: scale } }
        });
        Composite.add(world, berry);
    };
}

function spawnMultiple() {
    if(!gyroRequested) requestGyro(); // –ó–∞–ø—Ä–æ—Å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
    const count = parseInt(document.getElementById('countInput').value);
    for(let i=0; i<count; i++) {
        createBerry(Math.random()*(window.innerWidth-60)+30, 50);
    }
}

function clearAll() {
    if(!gyroRequested) requestGyro();
    Composite.allBodies(world).forEach(b => { if(!b.isStatic) Composite.remove(world, b); });
}

function toggleSpace() {
    if(!gyroRequested) requestGyro();
    isSpaceMode = !isSpaceMode;
    document.getElementById('spaceBtn').classList.toggle('active-mode');
    
    if(isSpaceMode) {
        world.gravity.scale = 0; // –í—ã–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é
        // –î–∞–µ–º –ø–∏–Ω–æ–∫ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–µ–≤–µ—Å–æ–º–æ—Å—Ç–∏
        Composite.allBodies(world).forEach(b => {
            if(!b.isStatic) Body.setVelocity(b, { x: (Math.random()-0.5)*3, y: (Math.random()-0.5)*3 });
        });
    } else {
        world.gravity.scale = 0.001; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
const mouse = Mouse.create(render.canvas);
const mouseConstraint = MouseConstraint.create(engine, {
    mouse: mouse, constraint: { stiffness: 0.1, render: { visible: false } }
});
Composite.add(world, mouseConstraint);

// –≠—Ñ—Ñ–µ–∫—Ç –∫—Ä—É—á–µ–Ω–∏—è –ø—Ä–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–∏
Events.on(engine, 'afterUpdate', () => {
    if (mouseConstraint.draggedBody) {
        const b = mouseConstraint.draggedBody;
        Body.setAngularVelocity(b, b.angularVelocity + (Math.random()-0.5)*0.2);
    }
});

// –ì–∏—Ä–æ—Å–∫–æ–ø (–≤—Å–µ–≥–¥–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–µ–∫—Ç–æ—Ä —Å–∏–ª—ã)
function requestGyro() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(res => {
            if (res === 'granted') window.addEventListener('deviceorientation', handleGyro);
        });
    } else {
        window.addEventListener('deviceorientation', handleGyro);
    }
    gyroRequested = true;
}

function handleGyro(e) {
    const fx = e.gamma * 0.08;
    const fy = e.beta * 0.08;
    
    if (!isSpaceMode) {
        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: –≥–∏—Ä–æ—Å–∫–æ–ø —É–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–µ–π
        world.gravity.x = fx;
        world.gravity.y = fy;
    } else {
        // –†–µ–∂–∏–º –∫–æ—Å–º–æ—Å–∞: –≥–∏—Ä–æ—Å–∫–æ–ø –ø–ª–∞–≤–Ω–æ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã –∫ —Å—Ç–æ—Ä–æ–Ω–∞–º –Ω–∞–∫–ª–æ–Ω–∞
        const bodies = Composite.allBodies(world);
        bodies.forEach(b => {
            if(!b.isStatic) Body.applyForce(b, b.position, { x: fx * 0.001, y: fy * 0.001 });
        });
    }
}

window.addEventListener('resize', () => {
    render.canvas.width = window.innerWidth;
    render.canvas.height = window.innerHeight;
    createWalls();
});

spawnMultiple();
</script>
</body>
</html>
