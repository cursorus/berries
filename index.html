<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Berry Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        #ui { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: flex; gap: 12px; align-items: center;
            background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px);
            padding: 10px 20px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1);
        }

        .btn {
            width: 44px; height: 44px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; transition: 0.2s;
        }

        .btn svg { width: 22px; height: 22px; fill: currentColor; }
        .btn:active { transform: scale(0.85); }
        .active-mode { background: #9d4edd !important; box-shadow: 0 0 15px #9d4edd; }
        
        .controls { display: flex; flex-direction: column; align-items: center; gap: 2px; color: white; font-size: 10px; }
        input[type="range"] { width: 60px; accent-color: #9d4edd; cursor: pointer; }
        #countInput { width: 30px; background: none; border: none; color: white; text-align: center; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui">
    <div class="controls">
        <input type="number" id="countInput" value="5">
        <span>КОЛ-ВО</span>
    </div>

    <button class="btn" onclick="spawnMultiple()" title="Добавить">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>

    <div class="controls">
        <input type="range" id="speedRange" min="0.1" max="3" step="0.1" value="1">
        <span>СКОРОСТЬ</span>
    </div>

    <button class="btn" onclick="clearAll()" title="Очистить">
        <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/></svg>
    </button>

    <button id="sparkBtn" class="btn active-mode" onclick="toggleSparks()" title="Искры">
        <svg viewBox="0 0 24 24"><path d="M11.5,2L15.5,10L23.5,14L15.5,18L11.5,26L7.5,18L-0.5,14L7.5,10L11.5,2M11.5,7.83L9.91,11L6.73,12.58L9.91,14.17L11.5,17.35L13.09,14.17L16.27,12.58L13.09,11L11.5,7.83Z"/></svg>
    </button>

    <button id="spaceBtn" class="btn" onclick="toggleSpace()" title="Космос">
        <svg viewBox="0 0 24 24"><path d="M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5Z"/></svg>
    </button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Mouse, MouseConstraint, Events, Body } = Matter;

const engine = Engine.create();
const world = engine.world;
const render = Render.create({
    element: document.body,
    engine: engine,
    options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: 'transparent' }
});

Render.run(render);
Runner.run(Runner.create(), engine);

let walls = [];
function createWalls() {
    if (walls.length) Composite.remove(world, walls);
    const w = window.innerWidth, h = window.innerHeight;
    const opt = { isStatic: true, friction: 0.5, render: { visible: false } };
    walls = [
        Bodies.rectangle(w/2, h+25, w, 50, opt), Bodies.rectangle(w/2, -25, w, 50, opt),
        Bodies.rectangle(-25, h/2, 50, h, opt), Bodies.rectangle(w+25, h/2, 50, h, opt)
    ];
    Composite.add(world, walls);
}
createWalls();

const TARGET_SIZE = 80;
let isSpaceMode = false, gyroRequested = false, sparksEnabled = true;

// Функция для обрезки картинки в круг
function getCircularTexture(imgPath, size, callback) {
    const img = new Image();
    img.src = imgPath;
    img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.beginPath();
        ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
        ctx.clip();
        ctx.drawImage(img, 0, 0, size, size);
        callback(canvas.toDataURL());
    };
}

function createBerry(x, y) {
    const berryNum = Math.floor(Math.random() * 5) + 1;
    getCircularTexture(`berry${berryNum}.png`, 256, (circularImg) => {
        const berry = Bodies.circle(x, y, TARGET_SIZE/2, {
            restitution: 0.8, friction: 0.2,
            render: { sprite: { texture: circularImg, xScale: TARGET_SIZE/256, yScale: TARGET_SIZE/256 } }
        });
        Composite.add(world, berry);
    });
}

// Система искр (простой массив частиц)
let particles = [];
function createSpark(x, y) {
    if (!sparksEnabled) return;
    for (let i = 0; i < 3; i++) {
        particles.push({
            x, y, 
            vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
            life: 1.0, size: Math.random()*4 + 2
        });
    }
}

function spawnMultiple() {
    if(!gyroRequested) requestGyro();
    const count = parseInt(document.getElementById('countInput').value);
    for(let i=0; i<count; i++) createBerry(Math.random()*window.innerWidth, 50);
}

function clearAll() { Composite.allBodies(world).forEach(b => { if(!b.isStatic) Composite.remove(world, b); }); }
function toggleSpace() { isSpaceMode = !isSpaceMode; document.getElementById('spaceBtn').classList.toggle('active-mode'); }
function toggleSparks() { sparksEnabled = !sparksEnabled; document.getElementById('sparkBtn').classList.toggle('active-mode'); }

const mouseConstraint = MouseConstraint.create(engine, {
    mouse: Mouse.create(render.canvas), constraint: { stiffness: 0.1, render: { visible: false } }
});
Composite.add(world, mouseConstraint);

// Коллизии для искр
Events.on(engine, 'collisionStart', (event) => {
    event.pairs.forEach(pair => {
        const pos = pair.collision.supports[0];
        if (pos) createSpark(pos.x, pos.y);
    });
});

Events.on(engine, 'afterUpdate', () => {
    const speedMultiplier = document.getElementById('speedRange').value;
    
    // Применяем скорость и кручение
    Composite.allBodies(world).forEach(b => {
        if (!b.isStatic) {
            Body.setVelocity(b, { x: b.velocity.x * speedMultiplier, y: b.velocity.y * speedMultiplier });
            if (mouseConstraint.draggedBody === b) {
                Body.setAngularVelocity(b, b.angularVelocity + (Math.random()-0.5)*0.3);
            }
        }
    });
    
    // Отрисовка искр на канвасе рендера
    const ctx = render.context;
    particles = particles.filter(p => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.02;
        ctx.fillStyle = `rgba(157, 78, 221, ${p.life})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        return p.life > 0;
    });
});

function requestGyro() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(res => { if (res === 'granted') window.addEventListener('deviceorientation', handleGyro); });
    } else { window.addEventListener('deviceorientation', handleGyro); }
    gyroRequested = true;
}

function handleGyro(e) {
    const s = 0.08;
    if (!isSpaceMode) { world.gravity.x = e.gamma * s; world.gravity.y = e.beta * s; }
    else {
        Composite.allBodies(world).forEach(b => {
            if(!b.isStatic) Body.applyForce(b, b.position, { x: e.gamma * 0.0005, y: e.beta * 0.0005 });
        });
    }
}

window.addEventListener('resize', () => { render.canvas.width = window.innerWidth; render.canvas.height = window.innerHeight; createWalls(); });
spawnMultiple();
</script>
</body>
</html>
